{% extends "shop/base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">Votre panier</h1>

    <!-- Liste des produits dans le panier -->
    <div class="row">
        <div class="col-md-12">
            <ul class="list-group" id="item-list">
                <!-- Les articles seront ajoutés dynamiquement ici -->
                <h3 class="text-center" id="empty-message">Votre panier est vide.</h3>
            </ul>
        </div>
    </div>

    <!-- Affichage du total global -->
    <div class="row mt-4">
        <div class="col-md-12 text-right">
            <h4 id="total-price">Prix total : 0 €</h4>
        </div>
    </div>

    <!-- Formulaire de commande -->
    <form method="POST" id="checkout-form" class="mt-5">
        {% csrf_token %}
        <input type="hidden" id="panier" name="panier"> <!-- Champ caché pour transmettre les données du panier -->
        <button type="submit" class="btn btn-primary btn-lg btn-block" id="checkout-button" disabled>
            Passer la commande
        </button>
    </form>

</div>

{% endblock content %}

{% block scripts %}
<script type="text/javascript">
    // Récupérer le panier depuis le localStorage
    let panier = localStorage.getItem('panier') ? JSON.parse(localStorage.getItem('panier')) : {};

    const itemList = document.getElementById('item-list');
    const emptyMessage = document.getElementById('empty-message');
    const checkoutButton = document.getElementById('checkout-button');
    const panierInput = document.getElementById('panier');
    const totalPriceDisplay = document.getElementById('total-price');

    let totalPrice = 0;

    // Vérifier si le panier est vide
    if (Object.keys(panier).length === 0) {
        emptyMessage.style.display = "block";
        checkoutButton.disabled = true;
    } else {
        emptyMessage.style.display = "none";
        checkoutButton.disabled = false;

        // Ajouter les articles du panier à la liste
        for (let item in panier) {
            let details = panier[item]; // Récupérer les données du produit

            let quantite = parseInt(details[0]); // Quantité
            let nom = details[1]; // Nom du produit
            let prixUnitaire = parseFloat(details[2]); // Prix unitaire (converti en float)

            let totalProduit = quantite * prixUnitaire; // Calculer le total pour ce produit
            totalPrice += totalProduit; // Ajouter au total général

            // Ajouter l'article à la liste
            let listItem = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${nom}
                    <span class="badge badge-pill badge-secondary" style="color: green;">Prix unitaire : ${prixUnitaire.toFixed(2)} €</span>
                    <span class="badge badge-pill badge-primary" style="color: blue;">Quantité : ${quantite}</span>
                    <span class="badge badge-pill badge-danger">Total : ${totalProduit.toFixed(2)} €</span>
                </li>
            `;
            itemList.innerHTML += listItem;
        }

        // Ajouter le prix total dans le champ caché
        totalPriceDisplay.innerHTML = `Prix total : ${totalPrice.toFixed(2)} €`;
        panierInput.value = JSON.stringify(panier);
    }

    // Nettoyer le panier après validation (facultatif)
    document.getElementById('checkout-form').addEventListener('submit', function () {
        localStorage.removeItem('panier');
    });
</script>
{% endblock scripts %}